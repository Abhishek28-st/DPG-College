import mysql.connector 
import pandas as pd

# --- 1. CONFIGURE YOUR DATABASE CONNECTION ---
DB_CONFIG = {
    'host': 'ed-mysql-new-2024-cluster.cluster-cdgwz0dld6va.ap-south-1.rds.amazonaws.com',
    'user': 'harshit',
    'password': '0@E_YryZiH0Kr1Ls',
    'database': 'eazydiner'
}

# --- 2. PASTE YOUR LIST OF RESTAURANT IDS HERE ---
RESTAURANT_IDS = [
    110164,110904,111010,111293,111385,111526,111807,111945,111993,112071,112287,112855,113313,115520,115574,116128,116133,117055,118832,120351,120356,120357,120624,120784,120796,120806,121015,121431,220615,220739,220985,222344,224137,226006,227077,228482,230055,230500,330037,330118,330238,330242,330315,330660,330676,330982,331110,331111,331690,332706,335065,335312,335554,335646,335660,335698,335796,335943,336076,336286,336461,336557,336789,336852,336995,337277,500973,501345,501686,504495,504510,504533,504694,504784,505004,505134,600175,600182,601206,601447,601538,602030,603999,604335,604422,605132,605275,611602,612211,612310,612383,612506,612733,613205,613798,613951,617806,617810,617812,617860,617973,619710,619749,621914,622099,622120,622302,622596,622615,622749,622762,622870,622881,622882,622939,622942,623063,623066,624343,624544,624720,625994,626193,626393,626699,626731,626827,626922,627818,628062,628422,629302,630758,630883,631034,631171,634188,634190,634191,634193,634277,634409,634583,634584,634587,635418,635458,635462,635463,635619,635807,635844,637988,638117,638125,638255,638516,639258,639349,639441,639511,639652,639792,640078,640079,640158,640242,640243,640261,640575,640641,640727,641065,641217,641242,641276,641279,641280,642158,642249,643361,643413,643432,643459,643460,643479,643596,643653,643798,643950,643954,644019,644267,644268,644339,644377,644442,644669,644723,644736,644739,644741,644747,644755,644759,644922,645104,645152,645230,645336,645415,645436,645508,645816,645841,645947,646697,646787,646815,646816,647301,647322,647364,647387,647438,647515,647525,647536,647571,647641,647665,647788,647795,647825,647941,648169,648227,648252,648362,648367,648395,648592,648855,649000,649017,649104,649109,649130,649136,649326,649397,649660,650718,651655,651710,652061,652324,652625,652647,652651,652658,652714,652847,652860,653024,653060,653213,653257,653258,653283,653315,653344,653412,653650,653674,653703,653712,653733,653754,653755,653819,653853,654076,654091,654136,654395,654570,655615,655625,655722,655775,655993,655999,656028,656198,656237,656244,656246,656248,656253,656256,656258,656266,656269,656274,656280,656285,656286,656288,656289,656300,656302,656335,656343,656345,656363,656372,656375,656440,656443,657004,657222,657282,657291,657296,657330,657336,657445,657466,657600,657632,657840,657992,658033,658076,658084,658093,658190,658224,658242,658365,658377,658439,658441,658779,658811,659150,659151,659456,659599,659734,659936,660406,661018,661146,661196,661356,661413,661448,661506,661518,661528,661584,661808,662076,662079,662248,662334,662389,662392,662415,662476,662493,662607,662609,662629,662662,662709,662884,662885,663081,663120,663122,663282,663321,663409,663431,665240,665479,665495,665561,665686,665711,665716,665788,665791,665792,665795,665832,665864,665901,665949,665950,665959,665969,666000,666048,666147,666152,666154,666155,666156,666160,666162,666183,666187,666315,666328,666352,666364,666365,666366,667434,667776,668174,668355,668458,668462,668463,668500,668529,668602,668851,668885,668982,669085,669268,669269,669321,669374,669384,669396,669406,669408,669448,669449,669461,669463,669469,669512,669661,669673,669682,669685,669686,669691,669697,669698,669700,669702,669710,669745,669768,669771,669776,669825,669837,669844,669852,669856,669857,669877,669905,669915,669987,669998,670147,670192,670197,670203,670258,670285,670286,670374,670525,670542,670587,670639,670657,670677,670684,670686,670703,670704,670719,670731,670739,670740,670786,670804,670847,670852,670863,670946,670963,670984,670987,671026,671041,671094,671101,671223,671229,671297,671298,671305,671316,671353,671367,671456,671464,671475,671504,671535,671540,671559,671744,671748,671750,671751,671755,671756,671767,671796,671797,671800,671805,671809,671812,671815,671843,671882,671925,671952,671969,671976,672024,672078,672114,672131,672156,672162,672186,672291,672292,672817,672824,672829,672834,672864,672869,672876,672881,672914,672959,672964,672971,672975,672986,673004,673015,673031,673042,673132,673136,673145,673156,673183,673184,673191,673252,673279,673295,673317,673328,673364,673370,673412,673414,673415,673428,673472,673481,673491,673501,673502,673603,673613,673618,673656,673833,673852,673859,673962,673969,673986,673998,674054,674059,674061,674095,674096,674153,674158,674162,674246,674264,674268,674271,674274,674295,674319,674334,674348,674451,681716,681732,681739,681740,681743,681745,681747,681750,681753,681755,681760,681761,681766,681768,681769,681770,681771,681773,681781,681785,681792,681793,681798,681801,681810,681815,681816,681820,681823,681831,681833,681834,681837,681838,681845,681851,681855,681858,681870,681871,681872,681886,681890,681901,681904,681906,681907,681909,681910,681915,681917,681918,681919,681920,681921,681923,681924,681927,681928,681965,681967,681971,681972,681976,681979,681987,681988,681991,681995,682011,682015,682016,682033,682060,682062,682073,682097,682119,682120,682121,682123,682125,682130,682138,682139,682151,682154,682161,682173,682195,682202,682209,682210,682245,682269,682290,682300,682326,682362,682368,682375,682419,682422,682435,682445,682463,682475,682483,682497,682509,682525,682526,682544,682552,682574,682593,682598,682640,682654,682669,682732,682739,682748,682794,682799,682847,682849,682876,682878,682881,682882,682883,682885,682886,682890,682894,682919,682927,682945,682970,683000,683004,683015,683029,683033,683039,683041,683060,683072,683079,683087,683095,683098,683139,683151,683152,683154,683156,683219,683221,683232,683279,683281,683283,683296,683312,683321,683323,683367,683406,683427,683439,683446,683448,683459,683483,683501,683511,683513,683519,683521,683527,683538,683547,683575,683595,683618,683621,683629,683674,683677,683682,683687,683697,683706,683708,683709,683726,683801,683833,683853,683869,683870,683979,683980,683992,684006,684020,684047,684053,684066,684079,684114,684127,684130,684142,684145,684158,684161,684187,684191,684205,684209,684213,684223,684225,684228,684237,684274,684288,684302,684334,684352,684355,684365,684366,684371,684373,684392,684394,684398,684418,684429,684431,684444,684483,684498,684521,684523,684536,684553,684564,684565,684590,684593,684595,684596,684608,684642,684651,684675,684678,684700,684732,684756,684789,684798,684830,684854,684860,684863,684870,684908,684910,684913,684926,684936,684943,684959,684964,684976,684981,685000,685010,685019,685021,685022,685023,685024,685032,685105,685113,685161,685167,685168,685172,685185,685197,685219,685233,685261,685308,685312,685336,685367,685398,685420,685427,685477,685488,685494,685509,685511,685525,685534,685545,685549,685563,685608,685629,685631,685636,685644,685654,685668,685690,685726,685775,685778,685785,685787,685788,685789,685792,685793,685795,685801,685802,685803,685805,685811,685814,685815,685816,685819,685820,685822,685836,685838,685847,685880,685895,685899,685901,685911,685926,685930,685935,685942,685964,685968,685973,685977,685978,685986,685988,685989,685990,685991,685993,685994,685995,685996,685998,685999,686000,686004,686005,686007,686016,686017,686037,686038,686040,686042,686044,686049,686050,686052,686073,686085,686103,686115,686122,686135,686136,686158,686163,686166,686186,686196,686202,686206,686217,686222,686239,686262,686266,686267,686279,686281,686288,686301,686317,686352,686377,686381,686386,686389,686401,686408,686411,686417,686418,686419,686420,686434,686435,686438,686444,686445,686447,686459,686462,686468,686470,686473,686474,686481,686496,686501,686523,686525,686526,686532,686539,686540,686541,686544,686545,686546,686547,686548,686550,686553,686558,686561,686562,686563,686564,686569,686572,686573,686575,686577,686578,686579,686589,686593,686594,686631,686635,686641,686648,686654,686655,686657,686660,686668,686691,686696,686707,686709,686712,686718,686735,686738,686744,686746,686749,686750,686751,686753,686755,686756,686759,686767,686770,686771,686779,686800,686815,686824,686838,686852,686854,686855,686871,686877,686883,686905,686907,686912,686915,686923,686929,686935,686939,686952,686954,686955,686960,686965,686966,686968,686969,686976,687007,687025,687046,687053,687079,687087,687102,687120,687125,687126,687134,687140,687141,687142,687143,687147,687153,687154,687160,687161,687162,687168,687169,687171,687173,687183,687184,687193,687221,687222,687260,687264,687286,687306,687314,687315,687326,687341,687355,687356,687359,687361,687363,687367,687375,687393,687424,687431,687433,687435,687454,687458,687460,687462,687469,687471,687555,687561,687584,687598,687612,687627,687644,687651,687656,687666,687672,687681,687696,687735,687738,687745,687771,687774,687775,687777,687797,687806,687824,687826,687835,687839,687851,687885,687915,687919,687933,687943,687960,687962,687966,687969,687975,687976,687984,687985,687989,687990,687996,688007,688012,688015,688022,688026,688034,688065,688071,688075,688080,688082,688086,688090,688101,688113,688120,688123,688147,688189,688193,688197,688205,688230,688232,688266,688270,688276,688282,688283,688293,688296,688302,688305,688306,688307,688319,688329,688345,688349,688353,688359,688388,688404,688405,688479,688481,688553,688589,688613,688622,688636,688656,688690,688692,688693,688697,688727,688730,688732,688738,688740,688747,688752,688760,688781,688788,688801,688802,688807,688812,688823,688826,688830,688836,688838,688841,688842,688846,688858,688863,688864,688867,688869,688872,688879,688886,688887,688890,688893,688896,688904,688905,688909,688911,688914,688925,688936,688949,688954,688958,688964,688966,688975,688992,689003,689028,689029,689057,689061,689098,689103,689113,689115,689138,689153,689166,689169,689171,689179,689183,689185,689192,689193,689201,689213,689233,689242,689274,689275,689277,689278,689285,689298,689311,689312,689319,689325,689326,689330,689335,689336,689392,689399,689419,689424,689426,689429,689452,689457,689472,689474,689491,689518,689519,689534,689536,689541,689547,689549,689613,689618,689625,689631,689639,689640,689658,689679,689687,689696,689711,689715,689719,689726,689728,689733,689752,689757,689759,689763,689767,689768,689770,689771,689776,689780,689781,689783,689785,689789,689795,689797,689798,689828,689830,689831,689851,689858,689883,689888,689891,689895,689896,689897,689919,689923,689928,689932,689933,689936,689944,689961,689963,689968,690018,690034,690040,690043,690044,690060,690062,690065,690067,690074,690079,690089,690090,690108,690109,690118,690121,690139,690140,690142,690163,690165,690176,690181,690183,690190,690195,690204,690209,690210,690242,690245,690246,690258,690300,690317,690319,690321,690323,690333,690337,690372,690374,690391,690403,690416,690417,690418,690420,690422,690434,690439,690455,690460,690463,690464,690468,690470,690484,690487,690491,690492,690498,690500,690507,690513,690521,690530,690561,690600,690604,690621,690622,690628,690636,690638,690651,690652,690671,690674,690680,690683,690687,690710,690713,690728,690732,690733,690736,690737,690742,690754,690768,690782,690794,690805,690806,690826,690827,690832,690837,690851,690879,690900,690901,690903,690910,690931,690933,690943,690969,690971,690973,690975,690997,691006,691024,691033,691036,691045,691057,691063,691070,691071,691090,691092,691121,691132,691136,691145,691150,691169,691188,691189,691190,691221,691223,691233,691248,691258,691260,691262,691265,691279,691285,691304,691320,691323,691324,691336,691337,691342,691358,691373,691394,691409,691414,691429,691437,691438,691442,691447,691448,691471,691474,691486,691488,691493,691497,691502,691503,691507,691511,691512,691515,691520,691521,691522,691526,691531,691544,691550,691559,691562,691566,691567,691569,691570,691574,691578,691601,691624,691638,691648,691651,691680,691682,691696,691700,691701,691703,691710,691717,691719,691727,691734,691736,691739,691740,691741,691745,691747,691752,691769,691771,691773,691780,691783,691784,691794,691796,691800,691801,691813,691826,691837,691839,691840,691841,691850,691856,691859,691880,691882,691883,691903,691919,691920,691926,691929,691930,691931,691933,691946,691951,691953,691957,691962,691965,691970,691976,691982,691984,691988,691993,691996,691997,692004,692010,692013,692017,692020,692028,692033,692036,692040,692041,692042,692043,692045,692046,692064,692067,692080,692094,692107,692115,692116,692135,692136,692143,692144,692149,692151,692153,692157,692160,692172,692183,692190,692194,692196,692202,692207,692208,692209,692211,692218,692222,692227,692237,692254,692259,692261,692264,692277,692278,692287,692291,692294,692309,692325,692339,692352,692364,692372,692377,692378,692388,692392,692405,692411,692421,692425,692438,692449,692454,692465,692467,692468,692475,692479,692481,692483,692486,692492,692497,692509,692510,692515,692516,692519,692523,692524,692526,692527,692539,692543,692544,692549,692553,692557,692562,692563,692566,692568,692569,692570,692572,692580,692583,692601,692604,692605,692606,692608,692615,692630,692652,692659,692672,692674,692687,692689,692700,692701,692710,692714,692726,692728,692738,692740,692741,692745,692754,692756,692765,692769,692777,692787,692789,692790,692801,692805,692807,692808,692813,692816,692821,692823,692824,692831,692832,692838,692840,692841,692842,692845,692857,692858,692864,692873,692875,692876,692882,692889,692891,692896,692899,692901,692909,692913,692916,692926,692928,692931,692932,692952,692960,692964,692966,692968,692969,692973,692982,692984,692988,692989,692994,692998,692999,693000,693001,693004,693007,693019,693024,693039,693041,693071,693072,693074,693079,693082,693090,693099,693109,693110,693112,693115,693118,693121,693138,693143,693151,693154,693162,693165,693174,693185,693196,693199,693201,693202,693205,693212,693215,693219,693221,693227,693229,693231,693233,693235,693253,693284,693286,693289,693292,693305,693319,693324,693325,693326,693335,693342,693345,693347,693350,693351,693352,693357,693369,693372,693374,693391,693399,693402,693405,693407,693432,693439,693451,693458,693465,693466,693474,693476,693483,693495,693498,693499,693504,693505,693511,693528,693533,693537,693541,693542,693543,693546,693551,693554,693559,693565,693570,693583,693588,693598,693607,693611,693612,693621,693623,693626,693627,693636,693641,693642,693647,693652,693654,693655,693657,693658,693659,693663,693666,693669,693677,693688,693705,693706,693712,693714,693717,693720,693727,693731,693738,693739,693748,693760,693761,693781,693802,693821,693822,693825,693830,693837,693840,693849,693854,693863,693865,693867,693887,693888,693889,693901,693904,693909,693911,693930,693937,693939,693945,693946,693955,693963,693965,693969,693973,693981,693982,693988,693992,693997,694001,694004,694007,694018,694023,694028,694036,694039,694046,694054,694064,694069,694070,694072,694079,694088,694094,694095,694097,694105,694106,694108,694117,694118,694123,694129,694134,694143,694145,694160,694171,694184,694185,694188,694189,694190,694192,694195,694203,694211,694214,694230,694235,694237,694244,694252,694253,694265,694269,694279,694288,694297,694307,694308,694312,694315,694328,694331,694334,694335,694340,694346,694354,694355,694357,694368,694371,694375,694376,694379,694383,694385,694389,694395,694398,694399,694424,694432,694455,694458,694465,694477,694487,694488,694502,694507,694512,694516,694523,694534,694543,694546,694551,694552,694560,694574,694579,694586,694600,694608,694611,694618,694623,694641,694644,694650,694663,694664,694667,694668,694682,694684,694687,694688,694691,694692,694693,694697,694700,694710,694711,694714,694721,694725,694737,694740,694741,694748,694752,694760,694764,694765,694778,694793,694794,694796,694801,694804,694805,694808,694820,694832,694833,694835,694842,694845,694849,694854,694856,694857,694860,694865,694868,694872,694876,694877,694881,694882,694886,694890,694898,694899,694900,694907,694909,694910,694911,694915,694917,694922,694927,694930,694933,694935,694939,694970,694972,694987,694988,694994,694997,695003,695012,695024,695031,695044,695045,695046,695058,695066,695071,695072,695076,695089,695090,695092,695094,695101,695103,695111,695113,695119,695120,695121,695129,695130,695131,695159,695162,695174,695184,695185,695187,695189,695195,695205,695225,695231,695236,695238,695246,695253,695259,695266,695268,695271,695278,695280,695283,695286,695287,695294,695296,695299,695302,695312,695322,695332,695333,695335,695346,695354,695358,695362,695381,695382,695385,695387,695393,695396,695398,695407,695408,695412,695416,695421,695424,695431,695449,695452,695477,695503,695513,695538,695543,695546,695552,695571,695590,695602,695603,695648,695650,695661,695662,695677,695758,695774,695776,695782,695801,695824,695830,695834,695841,695848,695866,695873,695874,695878,695881,695885,695886,695887,695890,695902,695905,695909,695921,695929,695931,695945,695949,695955,695960,695968,695971,695987,695993,696029,696032,696045,696049,696062,696064,696066,696068,696070,696071,696074,696084,696086,696098,696102,696113,696118,696122,696138,696146,696154,696157,696160,696163,696169,696170,696173,696177,696181,696195,696198,696199,696200,696201,696203,696217,696229,696243,696244,696250,696251,696259,696268,696273,696274,696278,696279,696287,696294,696303,696306,696316,696320,696321,696324,696326,696327,696330,696339,696360,696362,696365,696366,696373,696380,696392,696401,696404,696412,696427,696432,696434,696436,696437,696438,696440,696441,696442,696443,696457,696461,696464,696472,696479,696484,696485,696487,696491,696501,696510,696511,696512,696522,696527,696528,696529,696534,696535,696540,696541,696543,696544,696545,696562,696576,696580,696581,696582,696586,696591,696606,696644,696656,696667,696675,696677,696681,696689,696690,696692,696694,696722,696739,696759,696760,696767,696769,696785,696792,696795,696816,696820,696821,696826,696844,696855,696863,696871,696872,696885,696899,696901,696907,696908,696912,696917,696927,696929,696930,696940,696942,696944,696946,696954,696965,696990,696999,697009,697010,697012,697030,697040,697042,697044,697047,697053,697055,697056,697062,697067,697089,697101,697107,697109,697127,697132,697140,697142,697152,697155,697162,697167,697170,697173,697177,697210,697211,697212,697213,697223,697227,697228,697231,697232,697233,697235,697236,697241,697242,697244,697248,697249,697255,697259,697260,697263,697265,697270,697272,697273,697288,697292,697293,697297,697310,697322,697330,697332,697337,697357,697358,697360,697388,697406,697423,697424,697428,697441,697540,697541,697558,697561,697564,697565,697566,697570,697578,697584,697596,697599,697600,697607,697614,697616,697619,697621,697627,697632,697634,697643,697648,697655,697659,697673,697687,697689,697692,697706,697725,697735,697737,697738,697751,697759,697760,697764,697780,697793,697806,697815,697820,697826,697838,697845,697847,697851,697852,697856,697864,697868,697872,697887,697889,697893,697900,697912,697919,697922,697925,697961,697963,697976,697979,697991,698001,698003,698013,698029,698031,698038,698039,698042,698049,698052,698054,698059,698063,698065,698069,698077,698081,698087,698094,698106,698110,698122,698130,698131,698132,698133,698139,698165,698169,698170,698171,698172,698174,698183,698197,698206,698207,698208,698221,698222,698229,698231,698232,698242,698269,698272,698278,698281,698289,698298,698299,698304,698305,698306,698321,698334,698347,698360,698380,698386,698390,698393,698394,698399,698406,698407,698411,698412,698415,698419,698429,698447,698455,698457,698461,698469,698473,698474,698477,698488,698498,698504,698514,698516,698525,698532,698533,698536,698540,698545,698558,698560,698561,698566,698568,698569,698572,698578,698584,698595,698603,698616,698624,698634,698637,698639,698650,698661,698667,698680,698682,698685,698691,698694,698701,698705,698720,698723,698726,698768,698770,698773,698776,698779,698780,698783,698784,698786,698789,698790,698802,698804,698805,698806,698808,698817,698819,698824,698827,698829,698833,698834,698835,698841,698842,698843,698844,698845,698848,698853,698856,698860,698866,698867,698884,698888,698893,698904,698906,698911,698918,698920,698936,698948,698953,698958,698963,698988,698989,698993,698999,699000,699001,699025,699035,699037,699045,699054,699056,699057,699059,699064,699067,699070,699074,699075,699080,699084,699085,699086,699089,699091,699104,699116,699118,699124,699128,699132,699137,699140,699149,699169,699170,699175,699191,699194,699216,699221,699222,699229,699233,699243,699254,699256,699268,699270,699276,699281,699284,699286,699294,699298,699307,699308,699315,699325,699327,699332,699334,699339,699340,699346,699355,699359,699370,699372,699378,699382,699389,699396,699397,699399,699403,699408,699419,699422,699424,699429,699436,699438,699439,699443,699446,699447,699450,699452,699453,699462,699465,699469,699471,699476,699477,699479,699488,699493,699499,699505,699510,699529,699531,699563,699570,699573,699576,699577,699580,699581,699590,699597,699598,699605,699607,699610,699613,699618,699619,699621,699625,699628,699631,699639,699645,699657,699658,699663,699672,699678,699681,699684,699685,699686,699687,699689,699695,699702,699703,699719,699722,699727,699738,699739,699746,699752,699764,699766,699768,699769,699778,699780,699784,699791,699795,699798,699803,699815,699819,699822,699824,699825,699849,699854,699857,699871,699881,699887,699895,699897,699901,699907,699914,699932,699933,699949,699965,699967,699968,699970,699973,699977,699980,699995,699996,699998,700001,700007,700010,700011,700012,700014,700015,700019,700031,700040,700041,700046,700048,700051,700052,700053,700072,700077,700092,700093,700098,700101,700103,700128,700129,700132,700140,700141,700155,700157,700164,700169,700171,700182,700183,700190,700193,700196,700199,700200,700206,700214,700220,700235,700238,700242,700255,700257,700258,700262,700267,700272,700278,700290,700291,700292,700297,700298,700301,700305,700308,700310,700314,700327,700332,700336,700347,700380,700385,700396,700411,700450,700457,700463,700471,700472,700474,700475,700485,700487,700503,700504,700512,700513,700515,700522,700527,700534,700543,700545,700546,700547,700549,700556,700567,700575,700580,700590,700596,700598,700611,700619,700624,700628,700634,700643,700649,700651,700655,700656,700657,700658,700665,700669,700674,700679,700688,700691,700693,700694,700699,700714,700725,700729,700735,700739,700740,700751,700761,700762,700764,700769,700776,700779,700784,700786,700802,700803,700814,700817,700828,700829,700856,700857,700861,700868,700881,700882,700888,700892,700899,700901,700902,700903,700906,700910,700922,700923,700927,700931,700939,700945,700961,700965,700966,700979,700980,701010,701014,701020,701030,701037,701038,701050,701072,701078,701081,701082,701089,701090,701091,701098,701099,701102,701109,701120,701122,701124,701133,701160,701164,701165,701170,701176,701191,701192,701194,701200,701202,701208,701209,701212,701213,701216,701219,701224,701225,701231,701238,701239,701240,701249,701254,701266,701272,701274,701276,701277,701280,701282,701285,701287,701297,701301,701305,701307,701308,701310,701322,701323,701325,701327,701331,701363,701365,701369,701372,701373,701374,701376,701381,701385,701390,701396,701400,701412,701419,701430,701434,701441,701456,701462,701468,701481,701489,701491,701493,701499,701512,701520,701528,701553,701566,701570,701572,701580,701592,701596,701607,701612,701615,701618,701633,701634,701635,701638,701641,701643,701651,701657,701664,701665,701671,701672,701676,701681,701684,701687,701692,701698,701703,701706,701707,701708,701709,701710,701726,701738,701741,701743,701755,701759,701778,701784,701806,701813,701827,701837,701841,701851,701854,701870,701874,701877,701881,701914,701926,701934,701937,701945,701946,701951,701952,701955,701968,701980,701988,702016,702027,702033,702034,702038,702048,702049,702062,702064,702068,702069,702074,702075,702080,702083,702112,702119,702123,702127,702131,702134,702137,702138,702139,702144,702168,702175,702183,702192,702193,702198,702200,702202,702212,702218,702221,702223,702246,702254,702262,702274,702276,702295,702296,702299,702312,702324,702325,702326,702329,702338,702339,702340,702341,702342,702355,702361,702390,702401,702413,702414,702419,702420,702422,702428,702429,702431,702433,702437,702446,702457,702461,702462,702463,702465,702469,702471,702472,702479,702485,702487,702489,702491,702493,702505,702506,702512,702519,702522,702525,702528,702529,702535,702540,702541,702555,702563,702564,702566,702573,702587,702604,702611,702640,702648,702659,702665,702667,702674,702679,702688,702691,702693,702699,702701,702704,702709,702715,702727,702732,702750,702753,702759,702764,702776,702777,702799,702825,702826,702827,702838,702841,702853,702870,702883,702896,702897,702900,702905,702914,702919,702921,702923,702927,702930,702931,702932,702933,702936,702939,702944,702946,702952,702962,702973,702974,702975,702980,702984,702987,702990,702993,703002,703018,703050,703068,703069,703071,703073,703075,703080,703090,703105,703109,703114,703117,703122,703134,703135,703157,703160,703168,703171,703182,703193,703206,703209,703220,703224,703232,703241,703250,703266,703275,703286,703296,703297,703307,703313,703364,703375,703376,703378,703388,703395,703398,703402,703405,703410,703416,703420,703426,703431,703441,703442,703468,703471,703472,703486,703498,703500,703526,703530,703534,703537,703582,703618,703629,703634,703641,703643,703644,703649,703651,703676,703677,703678,703689,703701,703709,703715,703729,703730,703735,703746,703757,703759,703760,703763,703765,703768,703769,703772,703775,703776,703781,703782,703786,703791,703795,703801,703803,703811,703826,703828,703839,703844,703846,703851,703857,703869,703870,703875,703880,703884,703892,703893,703899,703904,703906,703918,703931,703933,703942,703943,703958,703964,703968,703971,703975,703981,703985,703987,703991,703992,703993,703994,703999,704002,704004,704005,704009,704012,704036,704045,704046,704066,704076,704079,704083,704084,704095,704099,704101,704108,704109,704114,704115,704121,704129,704130,704131,704147,704151,704168,704170,704173,704231,704232,704235,704236,704237,704239,704240,704241,704243,704252,704253,704254,704256,704260,704263,704284,704286,704295,704303,704315,704323,704324,704325,704329,704330,704331,704335,704349,704353,704354,704364,704385,704386,704393,704399,704401,704407,704414,704427,704428,704443,704457,704461,704467,704469,704471,704481,704484,704517,704538,704557,704559,704580,704584,704587,704594,704595,704596,704600,704634,704647,704685,704689,704692,704703,704712,704719,704727,704734,704744,704792,704795,704796,704798,704803,704805,704809,704822,704824,704836,704841,704847,704849,704856,704859,704866,704867,704881,704892,704901,704906,704907,704912,704917,704924,704930,704936,704938,704944,704951,704961,704965,704976,705010,705017,705028,705046,705048,705051,705060,705062,705074,705077,705081,705082,705085,705087,705089,705102,705109,705110,705120,705135,705140,705149,705150,705158,705166,705168,705169,705170,705171,705175,705176,705178,705202,705224,705225,705232,705235,705237,705248,705250,705253,705260,705262,705266,705273,705287,705288,705301,705308,705315,705321,705322,705325,705333,705338,705343,705346,705351,705358,705374,705383,705390,705395,705397,705405,705412,705424,705434,705446,705467,705468,705490,705499,705502,705504,705505,705512,705520,705521,705524,705525,705526,705527,705530,705534,705535,705537,705538,705542,705544,705545,705546,705548,705551,705553,705559,705561,705565,705567,705571,705573,705574,705579,705582,705583,705591,705607,705608,705610,705613,705619,705632,705639,705640,705654,705655,705658,705664,705672,705674,705681,705682,705684,705686,705688,705690,705692,705693,705695,705696,705697,705699,705700,705701,705702,705703,705704,705705,705706,705707,705708,705709,705711,705712,705713,705714,705715,705716,705717,705718,705719,705720,705721,705722,705723,705724,705725,705726,705727,705728,705729,705730,705731,705732,705733,705734,705735,705736,705737,705738,705740,705742,705743,705745,705746,705747,705748,705749,705750,705751,705753,705754,705757,705764,705765,705769,705771,705772,705774,705775,705778,705779,705780,705782,705783,705788,705792,705814,705834,705837,705840,705845,705852,705854,705856,705871,705874,705883,705891,705893,705894,705898,705899,705908,705910,705923,705925,705933,705939,705940,705941,705947,705949,705950,705954,705956,705957,705961,705970,705977,705979,705981,705983,705984,705990,705991,705993,706001,706014,706015,706016,706018,706023,706031,706036,706039,706041,706042,706045,706048,706063,706067,706074,706081,706085,706088,706089,706091,706092,706097,706098,706106,706109,706118,706120,706121,706130,706134,706135,706136,706139,706140,706141,706157,706162,706170,706173,706174,706175,706185,706188,706190,706194,706198,706206,706207,706212,706213,706217,706223,706236,706240,706247,706249,706251,706253,706257,706258,706261,706264,706275,706284,706286,706291,706303,706312,706313,706316,706317,706319,706320,706321,706326,706329,706335,706348,706353,706354,706374,706377,706382,706383,706386,706400,706401,706402,706410
]

# --- 3. THE SQL QUERY ---
SQL_QUERY = """
WITH recent_transactions AS (
    SELECT
        restaurant_id, customer_id, total_amount, lat_long, created_at,
        ROW_NUMBER() OVER (PARTITION BY restaurant_id ORDER BY created_at DESC) AS rn
    FROM eazypay_transactions
    WHERE status = 'complete' AND lat_long IS NOT NULL
),
latest_transactions AS (
    SELECT * FROM recent_transactions WHERE rn <= 20
),
customer_amounts AS (
    SELECT
        restaurant_id, customer_id, SUM(total_amount) AS total_amount
    FROM latest_transactions
    GROUP BY restaurant_id, customer_id
),
deduplicated_customers AS (
    SELECT restaurant_id, customer_id
    FROM (
        SELECT
            restaurant_id, customer_id, total_amount,
            COUNT(*) OVER (PARTITION BY restaurant_id, total_amount) AS amount_count
        FROM customer_amounts
    ) t
    WHERE amount_count = 1
),
valid_transactions AS (
    SELECT lt.restaurant_id, lt.customer_id, lt.lat_long
    FROM latest_transactions lt
    JOIN deduplicated_customers dc
      ON lt.restaurant_id = dc.restaurant_id AND lt.customer_id = dc.customer_id
),
rounded_locations AS (
    SELECT
        restaurant_id, customer_id,
        ROUND(CAST(SUBSTRING_INDEX(lat_long, ',', 1) AS DECIMAL(10,6)), 4) AS rounded_lat,
        ROUND(CAST(SUBSTRING_INDEX(lat_long, ',', -1) AS DECIMAL(10,6)), 4) AS rounded_long
    FROM valid_transactions
),
grouped_locations AS (
    SELECT
        restaurant_id, rounded_lat, rounded_long,
        COUNT(DISTINCT customer_id) AS occurrence_count
    FROM rounded_locations
    GROUP BY restaurant_id, rounded_lat, rounded_long
),
restaurant_summary AS (
    SELECT
        restaurant_id, SUM(occurrence_count) AS total_occurrences
    FROM grouped_locations
    GROUP BY restaurant_id
    HAVING SUM(occurrence_count) >= 5
),
filtered_locations AS (
    SELECT
        gl.restaurant_id, gl.rounded_lat, gl.rounded_long, gl.occurrence_count,
        rs.total_occurrences,
        (gl.occurrence_count * 100.0 / rs.total_occurrences) AS occurrence_percentage
    FROM grouped_locations gl
    JOIN restaurant_summary rs ON gl.restaurant_id = rs.restaurant_id
    WHERE (gl.occurrence_count * 100.0 / rs.total_occurrences) >= 5
),
ranked_locations AS (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY restaurant_id ORDER BY occurrence_count DESC) AS rn
    FROM filtered_locations
),
top_lat_long AS (
    SELECT
        restaurant_id,
        rounded_lat AS top_lat,
        rounded_long AS top_long
    FROM ranked_locations
    WHERE rn = 1
)
SELECT
    restaurant_id,
    top_lat,
    top_long
FROM top_lat_long
"""

def run_analysis():
    """
    Connects to the DB, runs the query in batches, and saves the result.
    """
    all_results = []
    connection = None
    try:
        # --- Establish connection ---
        print("Connecting to the database...")
        connection = mysql.connector.connect(**DB_CONFIG)
        
        cursor = connection.cursor(dictionary=True)

        # --- Process IDs in batches ---
        batch_size = 500
        for i in range(0, len(RESTAURANT_IDS), batch_size):
            batch_ids = RESTAURANT_IDS[i:i + batch_size]
            
            placeholders = ', '.join(['%s'] * len(batch_ids))
            
            batch_query = f"{SQL_QUERY} WHERE restaurant_id IN ({placeholders})"
            
            print(f"Running query for batch {i//batch_size + 1} ({len(batch_ids)} IDs)...")
            cursor.execute(batch_query, tuple(batch_ids))
            
            results = cursor.fetchall()
            if results:
                all_results.extend(results)
        
        print(f"\n✅ Query finished. Found {len(all_results)} results in total.")

        # --- Save results to a CSV file ---
        if all_results:
            df = pd.DataFrame(all_results)
            output_filename = 'restaurant_top_locations.csv'
            df.to_csv(output_filename, index=False)
            print(f"💾 Results saved to '{output_filename}'")
        else:
            print("No results to save.")

    except Exception as e:
        print(f"An error occurred: {e}")
    finally:
        if connection and connection.is_connected():
            cursor.close()
            connection.close()
            print("Database connection closed.")

if __name__ == "__main__":
    run_analysis()